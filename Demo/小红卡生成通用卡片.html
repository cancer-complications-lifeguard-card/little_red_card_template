<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小红卡 - 并发症管理指引生成器</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-red: #FF3B30;
            --dark-red: #D70015;
            --light-gray: #F2F2F7;
            --dark-gray: #1C1C1E;
            --medium-gray: #6B7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "PingFang SC", "Helvetica Neue", sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.6;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            outline: none;
        }

        input, textarea, select {
            font-family: inherit;
            outline: none;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-red);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 18px;
            color: var(--medium-gray);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: var(--medium-gray);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: var(--primary-red);
            border-bottom-color: var(--primary-red);
        }

        .tab-content {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 25%;
        }

        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--light-gray);
            color: var(--medium-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .step.active .step-number {
            background-color: var(--primary-red);
            color: white;
        }

        .step-title {
            font-size: 14px;
            text-align: center;
            color: var(--medium-gray);
        }

        .step.active .step-title {
            color: var(--primary-red);
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-gray);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .checkbox-item:hover {
            background-color: rgba(255, 59, 48, 0.1);
        }

        .checkbox-item.selected {
            background-color: rgba(255, 59, 48, 0.15);
            border: 1px solid var(--primary-red);
        }

        .checkbox-item input {
            margin-right: 10px;
            margin-top: 3px;
        }

        .checkbox-item-content h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .checkbox-item-content p {
            font-size: 14px;
            color: var(--medium-gray);
        }

        .contact-item,
        .hospital-item {
            background-color: var(--light-gray);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .contact-item h4,
        .hospital-item h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .contact-item p,
        .hospital-item p {
            font-size: 14px;
            margin-bottom: 5px;
        }

        .remove-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: transparent;
            color: var(--medium-gray);
            font-size: 18px;
            cursor: pointer;
        }

        .add-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px;
            background-color: transparent;
            border: 1px dashed var(--medium-gray);
            border-radius: 8px;
            color: var(--medium-gray);
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .add-button:hover {
            border-color: var(--primary-red);
            color: var(--primary-red);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .nav-button {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }

        .nav-button.prev {
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }

        .nav-button.next {
            background-color: var(--primary-red);
            color: white;
        }

        .nav-button.generate {
            background-color: var(--primary-red);
            color: white;
        }

        .card-preview {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .card-header {
            border-bottom: 1px solid var(--light-gray);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        .card-header h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-red);
        }

        .card-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .info-tag {
            font-size: 14px;
            background-color: var(--light-gray);
            padding: 6px 12px;
            border-radius: 20px;
        }

        .card-section {
            margin-bottom: 25px;
        }

        .card-section h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark-gray);
            display: flex;
            align-items: center;
        }

        .card-section h3 .icon {
            margin-right: 8px;
        }

        .warning-box {
            background-color: rgba(255, 59, 48, 0.1);
            border-left: 4px solid var(--primary-red);
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 0 8px 8px 0;
        }

        .warning-title {
            font-weight: 600;
            color: var(--primary-red);
            margin-bottom: 10px;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
        }

        .action-button {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }

        .action-button.primary {
            background-color: var(--primary-red);
            color: white;
        }

        .action-button.secondary {
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }

        .chat-container {
            height: 500px;
            display: flex;
            flex-direction: column;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--primary-red);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .ai-message {
            align-self: flex-start;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            border-bottom-left-radius: 6px;
        }

        .message-content {
            font-size: 16px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.7;
            text-align: right;
        }

        .chat-input {
            display: flex;
            padding: 15px;
            border-top: 1px solid var(--light-gray);
        }

        .chat-input textarea {
            flex: 1;
            border: 1px solid var(--light-gray);
            border-radius: 18px;
            padding: 12px 16px;
            font-size: 16px;
            resize: none;
            outline: none;
        }

        .send-button {
            margin-left: 15px;
            padding: 0 20px;
            background-color: var(--primary-red);
            color: white;
            border: none;
            border-radius: 18px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            align-self: flex-end;
        }

        .send-button:disabled {
            background-color: var(--light-gray);
            color: var(--medium-gray);
            cursor: not-allowed;
        }

        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .auth-form h2 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: var(--dark-gray);
        }

        .auth-button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-red);
            color: white;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            margin-top: 10px;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: var(--medium-gray);
        }

        .auth-toggle span {
            color: var(--primary-red);
            cursor: pointer;
        }

        .data-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .data-action {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .data-action h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark-gray);
        }

        .data-action p {
            font-size: 14px;
            color: var(--medium-gray);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .status-message {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .status-message.success {
            background-color: rgba(52, 199, 89, 0.1);
            color: #34C759;
        }

        .status-message.error {
            background-color: rgba(255, 59, 48, 0.1);
            color: var(--primary-red);
        }

        .hidden {
            display: none;
        }

        .file-input {
            display: none;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .logout-button {
            padding: 6px 12px;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            border-radius: 6px;
            font-size: 14px;
        }

        .model-selector {
            margin-bottom: 15px;
        }

        .model-selector select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--light-gray);
            border-radius: 6px;
            font-size: 14px;
        }

        .zhipu-login {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--light-gray);
        }

        .zhipu-login h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--dark-gray);
        }

        .zhipu-link {
            color: var(--primary-red);
            text-decoration: underline;
            margin-left: 5px;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--medium-gray);
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 主应用组件
        function App() {
            const [activeTab, setActiveTab] = React.useState('guide'); // 'guide' 或 'ai'
            
            return (
                <div className="app-container">
                    <div className="header">
                        <h1>小红卡</h1>
                        <p>并发症管理指引生成器</p>
                    </div>
                    
                    <div className="tabs">
                        <div 
                            className={`tab ${activeTab === 'guide' ? 'active' : ''}`}
                            onClick={() => setActiveTab('guide')}
                        >
                            指引生成
                        </div>
                        <div 
                            className={`tab ${activeTab === 'ai' ? 'active' : ''}`}
                            onClick={() => setActiveTab('ai')}
                        >
                            AI助手
                        </div>
                    </div>
                    
                    <div className="tab-content">
                        {activeTab === 'guide' ? <GuideGenerator /> : <AIAssistant />}
                    </div>
                </div>
            );
        }

        // 指引生成器组件
        function GuideGenerator() {
            const [currentStep, setCurrentStep] = React.useState(0);
            const [selectedComplications, setSelectedComplications] = React.useState([]);
            const [medicalInfo, setMedicalInfo] = React.useState({
                name: '',
                age: '',
                bloodType: '',
                mainDiagnosis: '',
                surgeryHistory: '',
                allergies: '',
                otherDiseases: '',
                isOnAnticoagulation: false,
                medicationType: '',
                lastTaken: '',
                stopReason: ''
            });
            const [emergencyContacts, setEmergencyContacts] = React.useState([]);
            const [hospitals, setHospitals] = React.useState([]);
            const [newContact, setNewContact] = React.useState({ name: '', phone: '', relationship: '' });
            const [newHospital, setNewHospital] = React.useState({ name: '', emergency: '', address: '', features: '' });
            
            // 从localStorage加载数据
            React.useEffect(() => {
                const savedComplications = JSON.parse(localStorage.getItem('selectedComplications') || '[]');
                const savedMedicalInfo = JSON.parse(localStorage.getItem('medicalInfo') || '{}');
                const savedContacts = JSON.parse(localStorage.getItem('emergencyContacts') || '[]');
                const savedHospitals = JSON.parse(localStorage.getItem('hospitals') || '[]');
                
                if (savedComplications.length > 0) {
                    setSelectedComplications(savedComplications);
                }
                
                if (Object.keys(savedMedicalInfo).length > 0) {
                    setMedicalInfo(savedMedicalInfo);
                }
                
                if (savedContacts.length > 0) {
                    setEmergencyContacts(savedContacts);
                }
                
                if (savedHospitals.length > 0) {
                    setHospitals(savedHospitals);
                }
            }, []);
            
            // 保存数据到localStorage
            React.useEffect(() => {
                localStorage.setItem('selectedComplications', JSON.stringify(selectedComplications));
            }, [selectedComplications]);
            
            React.useEffect(() => {
                localStorage.setItem('medicalInfo', JSON.stringify(medicalInfo));
            }, [medicalInfo]);
            
            React.useEffect(() => {
                localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));
            }, [emergencyContacts]);
            
            React.useEffect(() => {
                localStorage.setItem('hospitals', JSON.stringify(hospitals));
            }, [hospitals]);
            
            const complications = [
                { id: 'bleeding', name: '消化道出血', description: '呕血、黑便等症状的紧急处理' },
                { id: 'obstruction', name: '肠梗阻', description: '腹痛、呕吐、腹胀等症状的紧急处理' },
                { id: 'biliary', name: '胆道梗阻', description: '黄疸、发热等症状管理' },
                { id: 'infection', name: '感染', description: '发热、感染征象监测' },
                { id: 'ascites', name: '腹水', description: '腹胀、腹水症状管理' },
                { id: 'thrombosis', name: '血栓', description: '血栓形成预防和处理' }
            ];
            
            const handleComplicationChange = (id) => {
                if (selectedComplications.includes(id)) {
                    setSelectedComplications(selectedComplications.filter(c => c !== id));
                } else {
                    setSelectedComplications([...selectedComplications, id]);
                }
            };
            
            const handleMedicalInfoChange = (field, value) => {
                setMedicalInfo({
                    ...medicalInfo,
                    [field]: value
                });
            };
            
            const handleAddContact = () => {
                if (newContact.name && newContact.phone && newContact.relationship) {
                    setEmergencyContacts([...emergencyContacts, newContact]);
                    setNewContact({ name: '', phone: '', relationship: '' });
                }
            };
            
            const handleRemoveContact = (index) => {
                const newContacts = [...emergencyContacts];
                newContacts.splice(index, 1);
                setEmergencyContacts(newContacts);
            };
            
            const handleAddHospital = () => {
                if (newHospital.name && newHospital.emergency && newHospital.address) {
                    setHospitals([...hospitals, newHospital]);
                    setNewHospital({ name: '', emergency: '', address: '', features: '' });
                }
            };
            
            const handleRemoveHospital = (index) => {
                const newHospitals = [...hospitals];
                newHospitals.splice(index, 1);
                setHospitals(newHospitals);
            };
            
            const nextStep = () => {
                if (currentStep < 3) {
                    setCurrentStep(currentStep + 1);
                }
            };
            
            const prevStep = () => {
                if (currentStep > 0) {
                    setCurrentStep(currentStep - 1);
                }
            };
            
            const canProceed = () => {
                switch (currentStep) {
                    case 0: return selectedComplications.length > 0;
                    case 1: return medicalInfo.name && medicalInfo.bloodType;
                    case 2: return emergencyContacts.length > 0 || hospitals.length > 0;
                    default: return true;
                }
            };
            
            const renderStep = () => {
                switch (currentStep) {
                    case 0:
                        return (
                            <div>
                                <h2>选择并发症类型</h2>
                                <div className="checkbox-group">
                                    {complications.map(comp => (
                                        <div 
                                            key={comp.id}
                                            className={`checkbox-item ${selectedComplications.includes(comp.id) ? 'selected' : ''}`}
                                            onClick={() => handleComplicationChange(comp.id)}
                                        >
                                            <input 
                                                type="checkbox" 
                                                checked={selectedComplications.includes(comp.id)}
                                                onChange={() => {}}
                                            />
                                            <div className="checkbox-item-content">
                                                <h4>{comp.name}</h4>
                                                <p>{comp.description}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    case 1:
                        return (
                            <div>
                                <h2>填写个人医疗信息</h2>
                                <div className="form-group">
                                    <label>姓名 *</label>
                                    <input 
                                        type="text" 
                                        value={medicalInfo.name}
                                        onChange={(e) => handleMedicalInfoChange('name', e.target.value)}
                                        placeholder="请填写患者真实姓名"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>年龄</label>
                                    <input 
                                        type="text" 
                                        value={medicalInfo.age}
                                        onChange={(e) => handleMedicalInfoChange('age', e.target.value)}
                                        placeholder="请填写患者年龄"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>血型 *</label>
                                    <select 
                                        value={medicalInfo.bloodType}
                                        onChange={(e) => handleMedicalInfoChange('bloodType', e.target.value)}
                                    >
                                        <option value="">请选择血型</option>
                                        <option value="A型">A型</option>
                                        <option value="B型">B型</option>
                                        <option value="AB型">AB型</option>
                                        <option value="O型">O型</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>主要诊断</label>
                                    <input 
                                        type="text" 
                                        value={medicalInfo.mainDiagnosis}
                                        onChange={(e) => handleMedicalInfoChange('mainDiagnosis', e.target.value)}
                                        placeholder="如：胰腺癌、胃癌等"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>手术史</label>
                                    <textarea 
                                        value={medicalInfo.surgeryHistory}
                                        onChange={(e) => handleMedicalInfoChange('surgeryHistory', e.target.value)}
                                        placeholder="请填写手术史"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>过敏史</label>
                                    <input 
                                        type="text" 
                                        value={medicalInfo.allergies}
                                        onChange={(e) => handleMedicalInfoChange('allergies', e.target.value)}
                                        placeholder="请填写过敏史"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>其他疾病</label>
                                    <input 
                                        type="text" 
                                        value={medicalInfo.otherDiseases}
                                        onChange={(e) => handleMedicalInfoChange('otherDiseases', e.target.value)}
                                        placeholder="请填写其他疾病"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>⚠️ 抗凝治疗信息</label>
                                    <select 
                                        value={medicalInfo.isOnAnticoagulation ? 'true' : 'false'}
                                        onChange={(e) => handleMedicalInfoChange('isOnAnticoagulation', e.target.value === 'true')}
                                    >
                                        <option value="false">否</option>
                                        <option value="true">是</option>
                                    </select>
                                </div>
                                {medicalInfo.isOnAnticoagulation && (
                                    <>
                                        <div className="form-group">
                                            <label>抗凝药物种类</label>
                                            <input 
                                                type="text" 
                                                value={medicalInfo.medicationType}
                                                onChange={(e) => handleMedicalInfoChange('medicationType', e.target.value)}
                                                placeholder="请填写抗凝药物种类"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>最后服用时间</label>
                                            <input 
                                                type="text" 
                                                value={medicalInfo.lastTaken}
                                                onChange={(e) => handleMedicalInfoChange('lastTaken', e.target.value)}
                                                placeholder="请填写最后服用时间"
                                            />
                                        </div>
                                        <div className="form-group">
                                            <label>停药原因</label>
                                            <input 
                                                type="text" 
                                                value={medicalInfo.stopReason}
                                                onChange={(e) => handleMedicalInfoChange('stopReason', e.target.value)}
                                                placeholder="请填写停药原因"
                                            />
                                        </div>
                                    </>
                                )}
                            </div>
                        );
                    case 2:
                        return (
                            <div>
                                <h2>添加紧急联系人和医院信息</h2>
                                <h3>⚠️ 紧急联系人</h3>
                                {emergencyContacts.map((contact, index) => (
                                    <div key={index} className="contact-item">
                                        <button className="remove-button" onClick={() => handleRemoveContact(index)}>×</button>
                                        <h4>{contact.name} ({contact.relationship})</h4>
                                        <p>电话: {contact.phone}</p>
                                    </div>
                                ))}
                                <div className="add-button" onClick={() => {
                                    const nameInput = document.getElementById('contact-name');
                                    const phoneInput = document.getElementById('contact-phone');
                                    const relationshipInput = document.getElementById('contact-relationship');
                                    
                                    if (nameInput.value && phoneInput.value && relationshipInput.value) {
                                        handleAddContact();
                                    }
                                }}>
                                    + 添加紧急联系人
                                </div>
                                <div className="form-group">
                                    <label>姓名</label>
                                    <input 
                                        id="contact-name"
                                        type="text" 
                                        value={newContact.name}
                                        onChange={(e) => setNewContact({...newContact, name: e.target.value})}
                                        placeholder="请填写联系人姓名"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>电话</label>
                                    <input 
                                        id="contact-phone"
                                        type="text" 
                                        value={newContact.phone}
                                        onChange={(e) => setNewContact({...newContact, phone: e.target.value})}
                                        placeholder="请填写联系人电话"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>关系</label>
                                    <input 
                                        id="contact-relationship"
                                        type="text" 
                                        value={newContact.relationship}
                                        onChange={(e) => setNewContact({...newContact, relationship: e.target.value})}
                                        placeholder="请填写与患者关系"
                                    />
                                </div>
                                
                                <h3>⚠️ 医院信息</h3>
                                {hospitals.map((hospital, index) => (
                                    <div key={index} className="hospital-item">
                                        <button className="remove-button" onClick={() => handleRemoveHospital(index)}>×</button>
                                        <h4>{hospital.name}</h4>
                                        <p>急诊: {hospital.emergency}</p>
                                        <p>地址: {hospital.address}</p>
                                        {hospital.features && <p>特色: {hospital.features}</p>}
                                    </div>
                                ))}
                                <div className="add-button" onClick={() => {
                                    const nameInput = document.getElementById('hospital-name');
                                    const emergencyInput = document.getElementById('hospital-emergency');
                                    const addressInput = document.getElementById('hospital-address');
                                    
                                    if (nameInput.value && emergencyInput.value && addressInput.value) {
                                        handleAddHospital();
                                    }
                                }}>
                                    + 添加医院信息
                                </div>
                                <div className="form-group">
                                    <label>医院名称</label>
                                    <input 
                                        id="hospital-name"
                                        type="text" 
                                        value={newHospital.name}
                                        onChange={(e) => setNewHospital({...newHospital, name: e.target.value})}
                                        placeholder="请填写医院名称"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>急诊电话</label>
                                    <input 
                                        id="hospital-emergency"
                                        type="text" 
                                        value={newHospital.emergency}
                                        onChange={(e) => setNewHospital({...newHospital, emergency: e.target.value})}
                                        placeholder="请填写急诊电话"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>地址</label>
                                    <input 
                                        id="hospital-address"
                                        type="text" 
                                        value={newHospital.address}
                                        onChange={(e) => setNewHospital({...newHospital, address: e.target.value})}
                                        placeholder="请填写医院地址"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>特色</label>
                                    <input 
                                        type="text" 
                                        value={newHospital.features}
                                        onChange={(e) => setNewHospital({...newHospital, features: e.target.value})}
                                        placeholder="请填写医院特色（选填）"
                                    />
                                </div>
                            </div>
                        );
                    case 3:
                        return <CardPreview 
                            selectedComplications={selectedComplications}
                            medicalInfo={medicalInfo}
                            emergencyContacts={emergencyContacts}
                            hospitals={hospitals}
                        />;
                    default:
                        return null;
                }
            };
            
            return (
                <div>
                    <div className="steps">
                        <div className={`step ${currentStep >= 0 ? 'active' : ''}`}>
                            <div className="step-number">1</div>
                            <div className="step-title">选择并发症类型</div>
                        </div>
                        <div className={`step ${currentStep >= 1 ? 'active' : ''}`}>
                            <div className="step-number">2</div>
                            <div className="step-title">填写个人医疗信息</div>
                        </div>
                        <div className={`step ${currentStep >= 2 ? 'active' : ''}`}>
                            <div className="step-number">3</div>
                            <div className="step-title">添加紧急联系人和医院信息</div>
                        </div>
                        <div className={`step ${currentStep >= 3 ? 'active' : ''}`}>
                            <div className="step-number">4</div>
                            <div className="step-title">预览和下载</div>
                        </div>
                    </div>
                    
                    <div className="step-content">
                        {renderStep()}
                    </div>
                    
                    {currentStep < 3 && (
                        <div className="navigation">
                            <button 
                                className="nav-button prev" 
                                onClick={prevStep}
                                disabled={currentStep === 0}
                            >
                                上一步
                            </button>
                            <button 
                                className={`nav-button ${currentStep === 2 ? 'generate' : 'next'}`} 
                                onClick={nextStep}
                                disabled={!canProceed()}
                            >
                                {currentStep === 2 ? '生成指引卡片' : '下一步'}
                            </button>
                        </div>
                    )}
                </div>
            );
        }

        // 卡片预览组件
        function CardPreview({ selectedComplications, medicalInfo, emergencyContacts, hospitals }) {
            const cardRef = React.useRef(null);
            const [isGenerating, setIsGenerating] = React.useState(false);
            
            // 根据选择的并发症类型生成对应的急救指导
            const getEmergencyGuidance = () => {
                let guidance = [];
                
                if (selectedComplications.includes('bleeding')) {
                    guidance.push({
                        title: '消化道出血急救',
                        steps: [
                            '立即拨打120，告知消化道出血',
                            '绝对禁食禁水，保持呼吸道通畅',
                            '侧卧位，防止呕吐物误吸',
                            '记录呕血和黑便的量、颜色和时间',
                            '保存呕吐物样本，供医生查看'
                        ],
                        warnings: [
                            '禁止使用止痛药，可能掩盖症状',
                            '禁止热敷腹部，可能加重出血',
                            '禁止自行服用止血药'
                        ]
                    });
                }
                
                if (selectedComplications.includes('obstruction')) {
                    guidance.push({
                        title: '肠梗阻急救',
                        steps: [
                            '立即拨打120，告知肠梗阻症状',
                            '绝对禁食禁水，减轻肠道负担',
                            '禁止催吐，防止肠道穿孔',
                            '禁止使用止痛药，避免掩盖症状',
                            '禁止热敷腹部，防止肠管扩张'
                        ],
                        warnings: [
                            '禁止按摩腹部，可能导致肠穿孔',
                            '禁止使用泻药或灌肠，加重肠管损伤',
                            '禁止进食任何食物或液体'
                        ]
                    });
                }
                
                if (selectedComplications.includes('biliary')) {
                    guidance.push({
                        title: '胆道梗阻急救',
                        steps: [
                            '立即拨打120，告知黄疸、发热症状',
                            '绝对禁食禁水，减轻肝脏负担',
                            '记录体温变化，监测发热规律',
                            '观察皮肤和巩膜黄染程度',
                            '记录腹痛性质和部位变化'
                        ],
                        warnings: [
                            '禁止使用对肝脏有损害的药物',
                            '禁止饮酒，加重肝脏负担',
                            '禁止高脂饮食，加重胆道负担'
                        ]
                    });
                }
                
                if (selectedComplications.includes('infection')) {
                    guidance.push({
                        title: '感染急救',
                        steps: [
                            '立即拨打120，告知高热、感染症状',
                            '保持休息，减少体力消耗',
                            '补充水分，防止脱水',
                            '记录体温变化和发热规律',
                            '观察有无寒战、出汗等症状'
                        ],
                        warnings: [
                            '禁止自行使用抗生素，可能导致耐药',
                            '禁止捂汗，可能加重高热',
                            '禁止擅自降温，可能掩盖病情'
                        ]
                    });
                }
                
                if (selectedComplications.includes('ascites')) {
                    guidance.push({
                        title: '腹水急救',
                        steps: [
                            '立即拨打120，告知严重腹胀、呼吸困难',
                            '半坐卧位，减轻呼吸困难',
                            '限制水分和盐分摄入',
                            '记录腹围变化，观察腹胀程度',
                            '测量体重变化，监测腹水增减'
                        ],
                        warnings: [
                            '禁止大量饮水，加重腹水',
                            '禁止高盐饮食，增加水钠潴留',
                            '禁止腹部按摩，可能导致不适'
                        ]
                    });
                }
                
                if (selectedComplications.includes('thrombosis')) {
                    guidance.push({
                        title: '血栓急救',
                        steps: [
                            '立即拨打120，告知肢体肿胀、疼痛',
                            '保持患肢休息，避免活动',
                            '抬高患肢，减轻肿胀和疼痛',
                            '记录肢体肤色和温度变化',
                            '避免按摩患处，防止血栓脱落'
                        ],
                        warnings: [
                            '禁止热敷患处，可能加重血栓',
                            '禁止剧烈运动，可能导致血栓脱落',
                            '禁止自行服用抗凝药，可能导致出血'
                        ]
                    });
                }
                
                return guidance;
            };
            
            // 根据选择的并发症类型生成对应的诊断指引
            const getDiagnosisGuidance = () => {
                let guidance = [];
                
                if (selectedComplications.includes('bleeding')) {
                    guidance.push({
                        title: '消化道出血诊断要点',
                        points: [
                            '呕血颜色：鲜红色提示活动性出血，咖啡色提示出血较慢或已停止',
                            '黑便：柏油样便提示上消化道出血，暗红色便提示下消化道出血',
                            '生命体征：心率增快、血压下降提示失血较多',
                            '伴随症状：头晕、心慌、出冷汗提示休克前期'
                        ]
                    });
                }
                
                if (selectedComplications.includes('obstruction')) {
                    guidance.push({
                        title: '肠梗阻诊断要点',
                        points: [
                            '腹痛：阵发性绞痛提示机械性梗阻，持续性胀痛提示麻痹性梗阻',
                            '呕吐：呕吐物含胆汁提示高位梗阻，含粪样物质提示低位梗阻',
                            '腹胀：腹部膨隆，可见肠型和蠕动波',
                            '停止排气排便：完全性肠梗阻的典型表现',
                            '腹部X线：可见液气平面和肠管扩张'
                        ]
                    });
                }
                
                if (selectedComplications.includes('biliary')) {
                    guidance.push({
                        title: '胆道梗阻诊断要点',
                        points: [
                            '黄疸：皮肤和巩膜黄染，尿色加深，大便颜色变浅',
                            '腹痛：右上腹持续性胀痛，可向右肩放射',
                            '发热：提示合并感染，如胆管炎',
                            'Charcot三联征：腹痛、寒战高热、黄疸提示急性胆管炎',
                            '实验室检查：总胆红素、直接胆红素升高，碱性磷酸酶升高'
                        ]
                    });
                }
                
                if (selectedComplications.includes('infection')) {
                    guidance.push({
                        title: '感染诊断要点',
                        points: [
                            '体温：持续高热或体温不升',
                            '血常规：白细胞计数升高，中性粒细胞比例升高',
                            'C反应蛋白：明显升高',
                            '降钙素原：严重细菌感染时升高',
                            '感染灶：局部红肿热痛，或有分泌物'
                        ]
                    });
                }
                
                if (selectedComplications.includes('ascites')) {
                    guidance.push({
                        title: '腹水诊断要点',
                        points: [
                            '腹胀：腹部膨隆，腹围增加',
                            '移动性浊音：体位改变时浊音区移动',
                            '液波震颤：大量腹水时出现',
                            '超声检查：腹腔内游离液体',
                            '腹水检查：明确腹水性质（漏出液、渗出液）'
                        ]
                    });
                }
                
                if (selectedComplications.includes('thrombosis')) {
                    guidance.push({
                        title: '血栓诊断要点',
                        points: [
                            '肢体肿胀：单侧肢体明显肿胀',
                            '疼痛：肢体胀痛，活动时加重',
                            '皮肤颜色：发红或发绀',
                            '皮肤温度：皮温升高',
                            '超声检查：血管内血栓形成'
                        ]
                    });
                }
                
                return guidance;
            };
            
            // 根据选择的并发症类型生成对应的日常预防建议
            const getPreventionGuidance = () => {
                let guidance = {
                    diet: [],
                    activity: [],
                    medication: []
                };
                
                if (selectedComplications.includes('bleeding')) {
                    guidance.diet.push(
                        '避免辛辣刺激性食物',
                        '避免粗糙、坚硬食物',
                        '避免过热食物',
                        '少量多餐，避免过饱',
                        '戒烟限酒'
                    );
                    guidance.activity.push(
                        '避免剧烈运动',
                        '避免重体力劳动',
                        '保持情绪稳定'
                    );
                    guidance.medication.push(
                        '避免使用非甾体抗炎药',
                        '避免使用抗凝药物（除非医嘱）',
                        '避免使用激素类药物'
                    );
                }
                
                if (selectedComplications.includes('obstruction')) {
                    guidance.diet.push(
                        '避免高纤维食物：芹菜、韭菜、豆皮',
                        '避免难消化食物：糯米、坚果、年糕',
                        '避免易产气食物：豆类、洋葱、碳酸饮料',
                        '少量多餐，细嚼慢咽',
                        '避免过冷、过热食物'
                    );
                    guidance.activity.push(
                        '餐后30分钟再活动',
                        '避免剧烈运动和重体力劳动',
                        '适当散步，促进肠蠕动',
                        '避免久坐久卧'
                    );
                    guidance.medication.push(
                        '避免使用影响肠蠕动的药物',
                        '避免使用阿片类止痛药',
                        '避免使用抗胆碱药物'
                    );
                }
                
                if (selectedComplications.includes('biliary')) {
                    guidance.diet.push(
                        '低脂饮食，避免油炸食物',
                        '避免高胆固醇食物：动物内脏、蛋黄',
                        '少量多餐，避免过饱',
                        '避免饮酒',
                        '增加膳食纤维摄入'
                    );
                    guidance.activity.push(
                        '适当运动，控制体重',
                        '避免久坐',
                        '保持规律作息'
                    );
                    guidance.medication.push(
                        '避免对肝脏有损害的药物',
                        '慎用止痛药',
                        '避免饮酒同时服药'
                    );
                }
                
                if (selectedComplications.includes('infection')) {
                    guidance.diet.push(
                        '均衡营养，增强免疫力',
                        '避免生冷、不洁食物',
                        '充分饮水',
                        '增加蛋白质摄入',
                        '适量补充维生素'
                    );
                    guidance.activity.push(
                        '适当运动，增强体质',
                        '避免过度疲劳',
                        '保持充足睡眠',
                        '注意个人卫生'
                    );
                    guidance.medication.push(
                        '遵医嘱使用抗生素',
                        '不自行使用抗生素',
                        '完成全程治疗',
                        '注意药物副作用'
                    );
                }
                
                if (selectedComplications.includes('ascites')) {
                    guidance.diet.push(
                        '低盐饮食，每日盐摄入<5g',
                        '限制水分摄入',
                        '高质量蛋白质饮食',
                        '避免高钠食物：腌制品、加工食品',
                        '少量多餐，避免过饱'
                    );
                    guidance.activity.push(
                        '适当休息，避免疲劳',
                            '避免长时间站立或久坐',
                            '抬高下肢，减轻水肿',
                            '避免剧烈运动'
                        );
                        guidance.medication.push(
                            '遵医嘱使用利尿剂',
                            '监测电解质平衡',
                            '避免使用肾毒性药物',
                            '不自行调整药物剂量'
                        );
                    }
                    
                    if (selectedComplications.includes('thrombosis')) {
                        guidance.diet.push(
                            '低脂饮食，避免高脂食物',
                            '增加膳食纤维摄入',
                            '避免高糖食物',
                            '适量饮水',
                            '限制酒精摄入'
                        );
                        guidance.activity.push(
                            '适当活动，避免久坐',
                            '避免长时间保持同一姿势',
                            '进行下肢肌肉锻炼',
                            '避免剧烈运动'
                        );
                        guidance.medication.push(
                            '遵医嘱使用抗凝药物',
                            '定期监测凝血功能',
                            '避免自行调整药物剂量',
                            '注意出血倾向'
                        );
                    }
                    
                    // 去重
                    guidance.diet = [...new Set(guidance.diet)];
                    guidance.activity = [...new Set(guidance.activity)];
                    guidance.medication = [...new Set(guidance.medication)];
                    
                    return guidance;
                };
                
                const handleDownloadImage = async () => {
                    if (!cardRef.current) return;
                    
                    setIsGenerating(true);
                    try {
                        const canvas = await html2canvas(cardRef.current, {
                            scale: 2,
                            backgroundColor: '#FFFFFF'
                        });
                        const image = canvas.toDataURL('image/png');
                        const link = document.createElement('a');
                        link.href = image;
                        link.download = `${medicalInfo.name}_并发症管理指引.png`;
                        link.click();
                    } catch (error) {
                        console.error('生成图片失败:', error);
                        alert('生成图片失败，请重试');
                    } finally {
                        setIsGenerating(false);
                    }
                };
                
                const handleDownloadHTML = () => {
                    const emergencyGuidance = getEmergencyGuidance();
                    const diagnosisGuidance = getDiagnosisGuidance();
                    const preventionGuidance = getPreventionGuidance();
                    
                    // 根据指引卡格式生成完整的HTML模板
                    const htmlContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>小红卡|${medicalInfo.name}并发症管理指引</title>
  <style>
    body {
      font-family: "PingFang SC", "Helvetica Neue", sans-serif;
      background-color: #F2F2F7;
      color: #1C1C1E;
      line-height: 1.6;
      padding: 20px;
    }
    .card-container {
      max-width: 800px;
      margin: 0 auto;
      background-color: #FFFFFF;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      padding: 30px;
    }
    .card-header {
      border-bottom: 1px solid #F2F2F7;
      padding-bottom: 20px;
      margin-bottom: 20px;
    }
    .card-header h2 {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 10px;
      color: #FF3B30;
    }
    .card-info {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .info-tag {
      font-size: 14px;
      background-color: #F2F2F7;
      padding: 6px 12px;
      border-radius: 20px;
    }
    .card-section {
      margin-bottom: 25px;
    }
    .card-section h3 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #1C1C1E;
      display: flex;
      align-items: center;
    }
    .card-section h3 .icon {
      margin-right: 8px;
    }
    .warning-box {
      background-color: rgba(255, 59, 48, 0.1);
      border-left: 4px solid #FF3B30;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 0 8px 8px 0;
    }
    .warning-title {
      font-weight: 600;
      color: #FF3B30;
      margin-bottom: 10px;
    }
    .warning-steps {
      margin-bottom: 10px;
    }
    .warning-steps p {
      margin-bottom: 5px;
    }
    .warning-warnings {
      margin-top: 10px;
    }
    .warning-warnings p {
      margin-bottom: 5px;
      color: #FF3B30;
    }
    .diagnosis-box {
      background-color: #F2F2F7;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .diagnosis-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: #1C1C1E;
    }
    .diagnosis-points {
      margin-bottom: 5px;
    }
    .diagnosis-points p {
      margin-bottom: 5px;
    }
    .prevention-box {
      background-color: #F2F2F7;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
    }
    .prevention-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: #1C1C1E;
    }
    .prevention-category {
      margin-bottom: 10px;
    }
    .prevention-category h4 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 5px;
      color: #1C1C1E;
    }
    .prevention-list {
      margin-bottom: 5px;
    }
    .prevention-list p {
      margin-bottom: 5px;
    }
    .contact-item, .hospital-item {
      background-color: #F2F2F7;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .contact-item h4, .hospital-item h4 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 5px;
    }
    .contact-item p, .hospital-item p {
      font-size: 14px;
      margin-bottom: 5px;
    }
    .info-table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    .info-table th, .info-table td {
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid #F2F2F7;
    }
    .info-table th {
      font-weight: 600;
      color: #1C1C1E;
    }
    @media print {
      body {
        background-color: #FFFFFF;
        padding: 0;
      }
      .card-container {
        box-shadow: none;
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="card-container">
    <div class="card-header">
      <h2>小红卡|${medicalInfo.name}并发症管理指引</h2>
      <div class="card-info">
        <div class="info-tag">血型: ${medicalInfo.bloodType}</div>
        <div class="info-tag">年龄: ${medicalInfo.age}</div>
        <div class="info-tag">主要诊断: ${medicalInfo.mainDiagnosis}</div>
      </div>
    </div>
    
    <div class="card-section">
      <h3><span class="icon">🆘</span> 急救指导步骤</h3>
      ${emergencyGuidance.map(guidance => `
        <div class="warning-box">
          <div class="warning-title">${guidance.title}</div>
          <div class="warning-steps">
            ${guidance.steps.map(step => `<p>• ${step}</p>`).join('')}
          </div>
          <div class="warning-warnings">
            ${guidance.warnings.map(warning => `<p>⚠️ ${warning}</p>`).join('')}
          </div>
        </div>
      `).join('')}
    </div>
    
    <div class="card-section">
      <h3><span class="icon">🔍</span> 病情诊断关键指引</h3>
      ${diagnosisGuidance.map(guidance => `
        <div class="diagnosis-box">
          <div class="diagnosis-title">${guidance.title}</div>
          <div class="diagnosis-points">
            ${guidance.points.map(point => `<p>• ${point}</p>`).join('')}
          </div>
        </div>
      `).join('')}
    </div>
    
    <div class="card-section">
      <h3><span class="icon">🛡️</span> 日常注意和预防</h3>
      <div class="prevention-box">
        ${preventionGuidance.diet.length > 0 ? `
          <div class="prevention-category">
            <h4>饮食管理</h4>
            <div class="prevention-list">
              ${preventionGuidance.diet.map(item => `<p>• ${item}</p>`).join('')}
            </div>
          </div>
        ` : ''}
        
        ${preventionGuidance.activity.length > 0 ? `
          <div class="prevention-category">
            <h4>活动建议</h4>
            <div class="prevention-list">
              ${preventionGuidance.activity.map(item => `<p>• ${item}</p>`).join('')}
            </div>
          </div>
        ` : ''}
        
        ${preventionGuidance.medication.length > 0 ? `
          <div class="prevention-category">
            <h4>用药安全</h4>
            <div class="prevention-list">
              ${preventionGuidance.medication.map(item => `<p>• ${item}</p>`).join('')}
            </div>
          </div>
        ` : ''}
      </div>
    </div>
    
    <div class="card-section">
      <h3><span class="icon">🏥</span> 辅助服务</h3>
      
      <h4>个人医疗信息卡</h4>
      <table class="info-table">
        <tr>
          <th>项目</th>
          <th>内容</th>
        </tr>
        <tr>
          <td>姓名</td>
          <td>${medicalInfo.name}</td>
        </tr>
        <tr>
          <td>年龄</td>
          <td>${medicalInfo.age}</td>
        </tr>
        <tr>
          <td>血型</td>
          <td>${medicalInfo.bloodType}</td>
        </tr>
        <tr>
          <td>主要诊断</td>
          <td>${medicalInfo.mainDiagnosis}</td>
        </tr>
        <tr>
          <td>手术史</td>
          <td>${medicalInfo.surgeryHistory || '无'}</td>
        </tr>
        <tr>
          <td>过敏史</td>
          <td>${medicalInfo.allergies || '无'}</td>
        </tr>
        <tr>
          <td>其他疾病</td>
          <td>${medicalInfo.otherDiseases || '无'}</td>
        </tr>
        ${medicalInfo.isOnAnticoagulation ? `
        <tr>
          <td>抗凝药物</td>
          <td>${medicalInfo.medicationType || '未填写'}</td>
        </tr>
        <tr>
          <td>最后服药时间</td>
          <td>${medicalInfo.lastTaken || '未填写'}</td>
        </tr>
        ` : ''}
      </table>
      
      <h4>紧急联系人</h4>
      ${emergencyContacts.length > 0 ? emergencyContacts.map(contact => `
        <div class="contact-item">
          <h4>${contact.name} (${contact.relationship})</h4>
          <p>电话: ${contact.phone}</p>
        </div>
      `).join('') : '<p>暂无紧急联系人信息</p>'}
      
      <h4>医院信息</h4>
      ${hospitals.length > 0 ? hospitals.map(hospital => `
        <div class="hospital-item">
          <h4>${hospital.name}</h4>
          <p>急诊: ${hospital.emergency}</p>
          <p>地址: ${hospital.address}</p>
          ${hospital.features ? `<p>特色: ${hospital.features}</p>` : ''}
        </div>
      `).join('') : '<p>暂无医院信息</p>'}
    </div>
    
    <div class="card-section">
      <h3><span class="icon">📱</span> 日常提醒</h3>
      <p><strong>每日自检清单：</strong></p>
      <ul>
        <li>[ ] 排便情况正常</li>
        <li>[ ] 腹部无异常疼痛</li>
        <li>[ ] 饮食选择安全</li>
        <li>[ ] 按时服药</li>
        <li>[ ] 适当活动</li>
      </ul>
      
      <p><strong>定期复查提醒：</strong></p>
      <ul>
        <li>每周：自我症状评估</li>
        <li>每月：医院复查</li>
        <li>每季度：全面体检</li>
      </ul>
    </div>
  </div>
</body>
</html>
                `;
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `${medicalInfo.name}_并发症管理指引.html`;
                link.click();
                URL.revokeObjectURL(url);
            };
            
            const handleExportData = () => {
                const data = {
                    selectedComplications,
                    medicalInfo,
                    emergencyContacts,
                    hospitals,
                    exportDate: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `小红卡配置_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };
            
            const handleImportData = (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target?.result);
                        
                        // 验证数据格式
                        if (!data.selectedComplications || !data.medicalInfo) {
                            throw new Error('无效的配置文件格式');
                        }
                        
                        // 保存到localStorage
                        localStorage.setItem('selectedComplications', JSON.stringify(data.selectedComplications));
                        localStorage.setItem('medicalInfo', JSON.stringify(data.medicalInfo));
                        localStorage.setItem('emergencyContacts', JSON.stringify(data.emergencyContacts || []));
                        localStorage.setItem('hospitals', JSON.stringify(data.hospitals || []));
                        
                        alert('配置导入成功！请刷新页面');
                    } catch (error) {
                        alert('配置文件格式错误，请选择有效的配置文件');
                        console.error('导入失败:', error);
                    }
                };
                reader.readAsText(file);
            };
            
            const handleClearData = () => {
                if (window.confirm('确定要清空所有数据吗？此操作不可恢复。')) {
                    localStorage.clear();
                    alert('数据已清空，请刷新页面');
                }
            };
            
            const emergencyGuidance = getEmergencyGuidance();
            const diagnosisGuidance = getDiagnosisGuidance();
            const preventionGuidance = getPreventionGuidance();
            
            return (
                <div>
                    <div className="card-preview" ref={cardRef}>
                        <div className="card-header">
                            <h2>小红卡|{medicalInfo.name}并发症管理指引</h2>
                            <div className="card-info">
                                <div className="info-tag">血型: {medicalInfo.bloodType}</div>
                                <div className="info-tag">年龄: {medicalInfo.age}</div>
                                <div className="info-tag">主要诊断: {medicalInfo.mainDiagnosis}</div>
                            </div>
                        </div>
                        
                        <div className="card-section">
                            <h3><span className="icon">🆘</span> 急救指导步骤</h3>
                            {emergencyGuidance.map((guidance, index) => (
                                <div key={index} className="warning-box">
                                    <div className="warning-title">{guidance.title}</div>
                                    <div className="warning-steps">
                                        {guidance.steps.map((step, stepIndex) => (
                                            <p key={stepIndex}>• {step}</p>
                                        ))}
                                    </div>
                                    <div className="warning-warnings">
                                        {guidance.warnings.map((warning, warningIndex) => (
                                            <p key={warningIndex}>⚠️ {warning}</p>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div className="card-section">
                            <h3><span className="icon">🔍</span> 病情诊断关键指引</h3>
                            {diagnosisGuidance.map((guidance, index) => (
                                <div key={index} className="diagnosis-box">
                                    <div className="diagnosis-title">{guidance.title}</div>
                                    <div className="diagnosis-points">
                                        {guidance.points.map((point, pointIndex) => (
                                            <p key={pointIndex}>• {point}</p>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                        
                        <div className="card-section">
                            <h3><span className="icon">🛡️</span> 日常注意和预防</h3>
                            <div className="prevention-box">
                                {preventionGuidance.diet.length > 0 && (
                                    <div className="prevention-category">
                                        <h4>饮食管理</h4>
                                        <div className="prevention-list">
                                            {preventionGuidance.diet.map((item, index) => (
                                                <p key={index}>• {item}</p>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {preventionGuidance.activity.length > 0 && (
                                    <div className="prevention-category">
                                        <h4>活动建议</h4>
                                        <div className="prevention-list">
                                            {preventionGuidance.activity.map((item, index) => (
                                                <p key={index}>• {item}</p>
                                            ))}
                                        </div>
                                    </div>
                                )}
                                
                                {preventionGuidance.medication.length > 0 && (
                                    <div className="prevention-category">
                                        <h4>用药安全</h4>
                                        <div className="prevention-list">
                                            {preventionGuidance.medication.map((item, index) => (
                                                <p key={index}>• {item}</p>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                        
                        <div className="card-section">
                            <h3><span className="icon">🏥</span> 辅助服务</h3>
                            
                            <h4>个人医疗信息卡</h4>
                            <table className="info-table">
                                <tr>
                                    <th>项目</th>
                                    <th>内容</th>
                                </tr>
                                <tr>
                                    <td>姓名</td>
                                    <td>{medicalInfo.name}</td>
                                </tr>
                                <tr>
                                    <td>年龄</td>
                                    <td>{medicalInfo.age}</td>
                                </tr>
                                <tr>
                                    <td>血型</td>
                                    <td>{medicalInfo.bloodType}</td>
                                </tr>
                                <tr>
                                    <td>主要诊断</td>
                                    <td>{medicalInfo.mainDiagnosis}</td>
                                </tr>
                                <tr>
                                    <td>手术史</td>
                                    <td>{medicalInfo.surgeryHistory || '无'}</td>
                                </tr>
                                <tr>
                                    <td>过敏史</td>
                                    <td>{medicalInfo.allergies || '无'}</td>
                                </tr>
                                <tr>
                                    <td>其他疾病</td>
                                    <td>{medicalInfo.otherDiseases || '无'}</td>
                                </tr>
                                {medicalInfo.isOnAnticoagulation && (
                                    <>
                                        <tr>
                                            <td>抗凝药物</td>
                                            <td>{medicalInfo.medicationType || '未填写'}</td>
                                        </tr>
                                        <tr>
                                            <td>最后服药时间</td>
                                            <td>{medicalInfo.lastTaken || '未填写'}</td>
                                        </tr>
                                    </>
                                )}
                            </table>
                            
                            <h4>紧急联系人</h4>
                            {emergencyContacts.length > 0 ? (
                                emergencyContacts.map((contact, index) => (
                                    <div key={index} className="contact-item">
                                        <h4>{contact.name} ({contact.relationship})</h4>
                                        <p>电话: {contact.phone}</p>
                                    </div>
                                ))
                            ) : (
                                <p>暂无紧急联系人信息</p>
                            )}
                            
                            <h4>医院信息</h4>
                            {hospitals.length > 0 ? (
                                hospitals.map((hospital, index) => (
                                    <div key={index} className="hospital-item">
                                        <h4>{hospital.name}</h4>
                                        <p>急诊: {hospital.emergency}</p>
                                        <p>地址: {hospital.address}</p>
                                        {hospital.features && <p>特色: {hospital.features}</p>}
                                    </div>
                                ))
                            ) : (
                                <p>暂无医院信息</p>
                            )}
                        </div>
                        
                        <div className="card-section">
                            <h3><span className="icon">📱</span> 日常提醒</h3>
                            <p><strong>每日自检清单：</strong></p>
                            <ul>
                                <li>[ ] 排便情况正常</li>
                                <li>[ ] 腹部无异常疼痛</li>
                                <li>[ ] 饮食选择安全</li>
                                <li>[ ] 按时服药</li>
                                <li>[ ] 适当活动</li>
                            </ul>
                            
                            <p><strong>定期复查提醒：</strong></p>
                            <ul>
                                <li>每周：自我症状评估</li>
                                <li>每月：医院复查</li>
                                <li>每季度：全面体检</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div className="action-buttons">
                        <button 
                            className="action-button primary" 
                            onClick={handleDownloadImage}
                            disabled={isGenerating}
                        >
                            {isGenerating ? '生成中...' : '下载为图片'}
                        </button>
                        <button className="action-button primary" onClick={handleDownloadHTML}>
                            下载为HTML
                        </button>
                    </div>
                    
                    <div className="data-actions">
                        <div className="data-action">
                            <h3>导出配置</h3>
                            <p>将当前配置导出为JSON文件，可在其他设备上导入使用</p>
                            <button className="action-button primary" onClick={handleExportData}>
                                导出配置
                            </button>
                        </div>
                        
                        <div className="data-action">
                            <h3>导入配置</h3>
                            <p>从JSON文件导入配置，替换当前数据</p>
                            <label className="action-button secondary">
                                选择文件
                                <input 
                                    type="file" 
                                    accept=".json" 
                                    onChange={handleImportData} 
                                    className="file-input"
                                />
                            </label>
                        </div>
                        
                        <div className="data-action">
                            <h3>清空数据</h3>
                            <p>清除所有本地存储的数据，恢复初始状态</p>
                            <button className="action-button secondary" onClick={handleClearData}>
                                清空数据
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // AI助手组件
        function AIAssistant() {
            const [isLogin, setIsLogin] = React.useState(false);
            const [isLoggedIn, setIsLoggedIn] = React.useState(false);
            const [username, setUsername] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [confirmPassword, setConfirmPassword] = React.useState('');
            const [email, setEmail] = React.useState('');
            const [messages, setMessages] = React.useState([]);
            const [inputText, setInputText] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [selectedModel, setSelectedModel] = React.useState('glm-4.5-air'); // 默认使用glm-4.5-air
            const [zhipuApiKey, setZhipuApiKey] = React.useState('');
            const messagesEndRef = React.useRef(null);

            // 并发症AI助手的提示词
            const systemPrompt = `你是一位专业的多病种并发症管理助手，专注于为癌症、罕见病等多病种患者提供并发症管理支持。你的角色是整合循证医学证据、临床指南和患者经验，提供全周期、多维度支持。

## 核心职责
1. **并发症预防与识别**：提供常见并发症的早期识别方法和预防措施
2. **紧急情况处理**：指导患者在并发症急性发作时的应对措施
3. **日常管理建议**：提供饮食、活动、用药等方面的个性化建议
4. **心理支持**：关注患者的心理需求，提供情绪疏导建议
5. **资源对接**：协助患者找到合适的医疗资源和支持服务

## 专业知识领域
- **消化道出血**：呕血、黑便等症状的识别与处理
- **肠梗阻**：腹痛、呕吐、腹胀等症状的管理
- **胆道梗阻**：黄疸、发热等症状的处理
- **感染**：发热、感染征象的监测与应对
- **腹水**：腹胀、腹水症状的管理
- **血栓**：血栓形成预防和处理
- **其他并发症**：根据患者具体情况提供相应指导

## 沟通风格
- **专业权威**：基于医学证据提供准确信息
- **温暖体贴**：理解患者的焦虑和恐惧，提供情感支持
- **耐心细致**：详细解释医学概念，确保患者理解
- **反应迅速**：对紧急情况提供及时、明确的指导

## 回答格式
使用红绿灯风险警示系统进行风险分层：
- 🔴 **紧急危险**（立即就医）：生命体征不稳定、严重并发症、需要紧急医疗干预
- 🟡 **需要关注**（及时就医）：症状明显但暂无生命危险、需要专科评估
- 🟢 **相对安全**（观察处理）：症状轻微、可居家观察、有明确自我管理方案

按照小红卡四大模块结构输出：
1. 🆘 **急救指导步骤**（如需要）
2. 🔍 **病情诊断关键指引**
3. 🏠 **日常注意和预防**
4. 🤝 **辅助服务和资源对接**

## 重要提醒
- 明确说明不替代专业医疗判断，仅提供参考信息
- 紧急情况优先建议拨打120或立即就医
- 尊重个体差异，避免一刀切的建议
- 提供权威医疗信息来源，供患者进一步了解`;

            // 模拟登录状态
            React.useEffect(() => {
                const loggedIn = localStorage.getItem('isLoggedIn') === 'true';
                if (loggedIn) {
                    setIsLoggedIn(true);
                    setUsername(localStorage.getItem('username') || '');
                    const savedApiKey = localStorage.getItem('zhipuApiKey');
                    if (savedApiKey) {
                        setZhipuApiKey(savedApiKey);
                    }
                    const savedModel = localStorage.getItem('selectedModel');
                    if (savedModel) {
                        setSelectedModel(savedModel);
                    }
                }
            }, []);

            // 滚动到最新消息
            React.useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };

            const handleRegister = () => {
                if (!username || !password) {
                    alert('请填写用户名和密码');
                    return;
                }
                if (password !== confirmPassword) {
                    alert('两次输入的密码不一致');
                    return;
                }
                
                // 模拟注册成功
                alert('注册成功！请登录');
                setIsLogin(true);
            };

            const handleLogin = () => {
                if (!username || !password) {
                    alert('请填写用户名和密码');
                    return;
                }
                
                if (!zhipuApiKey) {
                    alert('请输入智谱AI API密钥');
                    return;
                }
                
                // 模拟登录成功
                setIsLoggedIn(true);
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('username', username);
                localStorage.setItem('zhipuApiKey', zhipuApiKey);
                localStorage.setItem('selectedModel', selectedModel);
                
                // 添加欢迎消息
                setMessages([
                    {
                        id: '1',
                        text: `您好，${username}！我是您的并发症管理AI助手，当前使用的是${getModelName(selectedModel)}模型。有什么可以帮助您的吗？`,
                        sender: 'ai',
                        timestamp: new Date()
                    }
                ]);
            };

            const handleLogout = () => {
                setIsLoggedIn(false);
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('username');
                localStorage.removeItem('zhipuApiKey');
                localStorage.removeItem('selectedModel');
                setMessages([]);
            };

            const getModelName = (model) => {
                switch(model) {
                    case 'glm-4.5': return 'GLM-4.5';
                    case 'glm-4.5-air': return 'GLM-4.5-Air';
                    case 'glm-4.5-airx': return 'GLM-4.5-AirX';
                    case 'glm-4.5-flash': return 'GLM-4.5-Flash';
                    case 'glm-4.1v-thinking-flashx': return 'GLM-4.1V-Thinking';
                    default: return model;
                }
            };

            const handleSendMessage = async () => {
                if (!inputText.trim()) return;
                
                // 添加用户消息
                const userMessage = {
                    id: Date.now().toString(),
                    text: inputText,
                    sender: 'user',
                    timestamp: new Date()
                };
                
                setMessages(prev => [...prev, userMessage]);
                setInputText('');
                setIsLoading(true);
                
                try {
                    // 调用智谱AI API
                    const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${zhipuApiKey}`
                        },
                        body: JSON.stringify({
                            model: selectedModel,
                            messages: [
                                {
                                    role: 'system',
                                    content: systemPrompt
                                },
                                {
                                    role: 'user',
                                    content: inputText
                                }
                            ],
                            max_tokens: 8000, // 提高token数到8000
                            temperature: 0.7,
                            stream: false
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('API请求失败');
                    }
                    
                    const data = await response.json();
                    const aiResponse = data.choices[0].message.content;
                    
                    // 添加AI回复
                    const aiMessage = {
                        id: (Date.now() + 1).toString(),
                        text: aiResponse,
                        sender: 'ai',
                        timestamp: new Date()
                    };
                    
                    setMessages(prev => [...prev, aiMessage]);
                } catch (error) {
                    console.error('API调用失败:', error);
                    
                    // 如果API调用失败，使用本地回复作为后备
                    const fallbackResponse = getAIResponse(inputText);
                    const aiMessage = {
                        id: (Date.now() + 1).toString(),
                        text: fallbackResponse,
                        sender: 'ai',
                        timestamp: new Date()
                    };
                    
                    setMessages(prev => [...prev, aiMessage]);
                } finally {
                    setIsLoading(false);
                }
            };

            const getAIResponse = (question) => {
                // 简单的回复逻辑，作为API调用失败时的后备
                const lowerQuestion = question.toLowerCase();
                
                if (lowerQuestion.includes('肠梗阻')) {
                    return `🟡 **注意警示**：肠梗阻需要医疗专业评估\n\n🏥 **建议时间**：建议24-48小时内就医\n\n🔍 **病情诊断关键指引**：\n- 密切观察腹痛性质、频率和部位\n- 记录呕吐物的颜色、量和次数\n- 注意腹胀程度和排气排便情况\n- 监测体温变化\n\n🏠 **日常注意和预防**：\n- 饮食：避免难消化食物如糯米、坚果\n- 活动：适当活动促进肠蠕动，避免剧烈运动\n- 用药：遵医嘱使用药物，不自行用药\n\n🤝 **辅助服务**：\n- 保存医生联系方式，随时咨询\n- 记录症状变化，便于医生评估\n- 准备好医保卡和病历资料`;
                } else if (lowerQuestion.includes('出血')) {
                    return `🔴 **紧急警示**：消化道出血可能危及生命\n\n⚠️ **立即行动**：请立即拨打120或前往最近医院急诊科\n\n🆘 **急救指导步骤**：\n1. 绝对禁食禁水\n2. 保持呼吸道通畅，侧卧位\n3. 记录呕血和黑便的量、颜色和时间\n4. 保持镇静，避免紧张加重出血\n\n🔍 **病情诊断关键指引**：\n- 呕血鲜红色提示活动性出血\n- 黑便呈柏油样提示上消化道出血\n- 头晕、心慌、出冷汗提示失血较多\n\n🏠 **日常注意和预防**：\n- 避免辛辣刺激性食物\n- 戒烟限酒\n- 避免使用非甾体抗炎药`;
                } else if (lowerQuestion.includes('饮食')) {
                    return `🟢 **相对安全**：饮食是并发症管理的重要方面\n\n🏠 **日常注意和预防**：\n\n**饮食原则**：\n- 少量多餐，避免过饱\n- 细嚼慢咽，充分消化\n- 避免过冷、过热、刺激性食物\n\n**推荐食物**：\n- 易消化的流质和半流质食物\n- 蒸蛋羹、软烂面条\n- 温热的汤类和粥类\n\n**避免食物**：\n- 难消化食物：糯米、坚果、粗纤维食物\n- 易产气食物：豆类、洋葱、碳酸饮料\n- 刺激性食物：辛辣、过酸、过咸食物\n\n**特殊情况**：\n- 出血风险：避免粗糙、坚硬食物\n- 肠梗阻风险：避免高纤维、难消化食物`;
                } else if (lowerQuestion.includes('药物')) {
                    return `🟡 **注意警示**：用药不当可能加重并发症\n\n🏠 **日常注意和预防**：\n\n**用药原则**：\n- 严格遵医嘱用药，不自行调整剂量\n- 了解药物名称、作用和副作用\n- 记录用药时间和剂量\n\n**需谨慎使用的药物**：\n- 非甾体抗炎药：可能加重出血风险\n- 阿片类止痛药：可能减慢肠蠕动\n- 抗胆碱药物：可能影响肠道功能\n\n**药物相互作用**：\n- 告知医生所有正在使用的药物\n- 包括处方药、非处方药和保健品\n- 注意中药与西药的相互作用\n\n**用药记录**：\n- 使用药盒或手机提醒按时服药\n- 记录用药后的反应和不适\n- 定期复查时告知医生用药情况`;
                } else {
                    return `感谢您的提问。作为并发症管理AI助手，我可以为您提供关于并发症预防、识别和处理的专业建议。\n\n🔍 **病情诊断关键指引**：\n- 密切观察身体变化，记录症状\n- 注意生命体征：体温、血压、心率等\n- 识别并发症的早期信号\n\n🏠 **日常注意和预防**：\n- 保持规律作息，充足睡眠\n- 均衡饮食，适量运动\n- 遵医嘱用药，定期复查\n\n🤝 **辅助服务**：\n- 保存医生联系方式\n- 准备好医保卡和病历资料\n- 了解附近医院的急诊信息\n\n您有具体的并发症问题需要咨询吗？`;
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };

            if (!isLoggedIn) {
                return (
                    <div className="auth-container">
                        {!isLogin ? (
                            <div className="auth-form">
                                <h2>注册账号</h2>
                                <div className="form-group">
                                    <label>用户名</label>
                                    <input 
                                        type="text" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)} 
                                        placeholder="请输入用户名" 
                                    />
                                </div>
                                <div className="form-group">
                                    <label>密码</label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                        placeholder="请输入密码" 
                                    />
                                </div>
                                <div className="form-group">
                                    <label>确认密码</label>
                                    <input 
                                        type="password" 
                                        value={confirmPassword} 
                                        onChange={(e) => setConfirmPassword(e.target.value)} 
                                        placeholder="请再次输入密码" 
                                    />
                                </div>
                                <div className="form-group">
                                    <label>邮箱(选填)</label>
                                    <input 
                                        type="email" 
                                        value={email} 
                                        onChange={(e) => setEmail(e.target.value)} 
                                        placeholder="请输入邮箱" 
                                    />
                                </div>
                                <button className="auth-button" onClick={handleRegister}>注册</button>
                                <div className="auth-toggle">
                                    已有账号？<span onClick={() => setIsLogin(true)}>登录</span>
                                </div>
                            </div>
                        ) : (
                            <div className="auth-form">
                                <h2>登录</h2>
                                <div className="form-group">
                                    <label>用户名</label>
                                    <input 
                                        type="text" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)} 
                                        placeholder="请输入用户名" 
                                    />
                                </div>
                                <div className="form-group">
                                    <label>密码</label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                        placeholder="请输入密码" 
                                    />
                                </div>
                                
                                <div className="model-selector">
                                    <label>选择模型</label>
                                    <select 
                                        value={selectedModel}
                                        onChange={(e) => setSelectedModel(e.target.value)}
                                    >
                                        <option value="glm-4.5">GLM-4.5</option>
                                        <option value="glm-4.5-air">GLM-4.5-Air (推荐)</option>
                                        <option value="glm-4.5-airx">GLM-4.5-AirX</option>
                                        <option value="glm-4.5-flash">GLM-4.5-Flash (免费)</option>
                                        <option value="glm-4.1v-thinking-flashx">GLM-4.1V-Thinking (免费)</option>                                        
                                    </select>
                                </div>
                                
                                <div className="zhipu-login">
                                    <h3>智谱AI API密钥</h3>
                                    <div className="form-group">
                                        <label>API密钥</label>
                                        <input 
                                            type="password" 
                                            value={zhipuApiKey} 
                                            onChange={(e) => setZhipuApiKey(e.target.value)} 
                                            placeholder="请输入智谱AI API密钥" 
                                        />
                                    </div>
                                    <p>
                                        没有API密钥？
                                        <a href="https://open.bigmodel.cn/" target="_blank" className="zhipu-link">点击注册智谱AI</a>
                                    </p>
                                </div>
                                
                                <button className="auth-button" onClick={handleLogin}>登录</button>
                                <div className="auth-toggle">
                                    没有账号？<span onClick={() => setIsLogin(false)}>注册</span>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }

            return (
                <div>
                    <div className="user-info">
                        <span>欢迎，{username} (当前模型: {getModelName(selectedModel)})</span>
                        <button className="logout-button" onClick={handleLogout}>退出</button>
                    </div>
                    
                    <div className="chat-container">
                        <div className="chat-messages">
                            {messages.map((message) => (
                                <div 
                                    key={message.id} 
                                    className={`message ${message.sender === 'user' ? 'user-message' : 'ai-message'}`}
                                >
                                    <div className="message-content">{message.text}</div>
                                    <div className="message-time">
                                        {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                </div>
                            ))}
                            {isLoading && (
                                <div className="message ai-message">
                                    <div className="message-content typing-indicator">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                        
                        <div className="chat-input">
                            <textarea
                                value={inputText}
                                onChange={(e) => setInputText(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="请输入您的问题..."
                                rows={2}
                            />
                            <button 
                                className="send-button" 
                                onClick={handleSendMessage}
                                disabled={!inputText.trim() || isLoading}
                            >
                                发送
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // 渲染应用
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>