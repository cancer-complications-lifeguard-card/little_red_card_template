<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢å¡ - å¹¶å‘ç—‡ç®¡ç†æŒ‡å¼•ç”Ÿæˆå™¨</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-red: #FF3B30;
            --dark-red: #D70015;
            --light-gray: #F2F2F7;
            --dark-gray: #1C1C1E;
            --medium-gray: #6B7280;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "PingFang SC", "Helvetica Neue", sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.6;
        }

        button {
            font-family: inherit;
            cursor: pointer;
            border: none;
            outline: none;
        }

        input, textarea, select {
            font-family: inherit;
            outline: none;
        }

        .app-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary-red);
            margin-bottom: 10px;
        }

        .header p {
            font-size: 18px;
            color: var(--medium-gray);
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: var(--medium-gray);
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab.active {
            color: var(--primary-red);
            border-bottom-color: var(--primary-red);
        }

        .tab-content {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 25%;
        }

        .step-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--light-gray);
            color: var(--medium-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .step.active .step-number {
            background-color: var(--primary-red);
            color: white;
        }

        .step-title {
            font-size: 14px;
            text-align: center;
            color: var(--medium-gray);
        }

        .step.active .step-title {
            color: var(--primary-red);
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-gray);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .checkbox-item {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .checkbox-item:hover {
            background-color: rgba(255, 59, 48, 0.1);
        }

        .checkbox-item.selected {
            background-color: rgba(255, 59, 48, 0.15);
            border: 1px solid var(--primary-red);
        }

        .checkbox-item input {
            margin-right: 10px;
            margin-top: 3px;
        }

        .checkbox-item-content h4 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .checkbox-item-content p {
            font-size: 14px;
            color: var(--medium-gray);
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--primary-red);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--dark-red);
        }

        .btn-secondary {
            background-color: var(--light-gray);
            color: var(--dark-gray);
        }

        .btn-secondary:hover {
            background-color: #E5E5EA;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .contact-list, .hospital-list {
            margin-bottom: 20px;
        }

        .contact-item, .hospital-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background-color: var(--light-gray);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .remove-btn {
            background-color: var(--primary-red);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
        }

        .card-preview {
            background-color: white;
            border: 2px solid var(--primary-red);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-red);
        }

        .card-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-red);
            margin-bottom: 5px;
        }

        .card-subtitle {
            font-size: 14px;
            color: var(--medium-gray);
        }

        .emergency-section {
            background-color: #FFF5F5;
            border: 2px solid var(--primary-red);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .emergency-title {
            color: var(--primary-red);
            font-weight: 600;
            margin-bottom: 10px;
        }

        .diagnosis-section {
            background-color: #F0F9FF;
            border: 1px solid #0EA5E9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .prevention-section {
            background-color: #F0FDF4;
            border: 1px solid #22C55E;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-weight: 600;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }

        .info-value {
            color: var(--medium-gray);
        }

        /* AIåŠ©æ‰‹æ ·å¼ */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .auth-form {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .auth-form h2 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-red);
        }

        .auth-button {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-red);
            color: white;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
        }

        .auth-toggle {
            text-align: center;
            color: var(--medium-gray);
        }

        .auth-toggle span {
            color: var(--primary-red);
            cursor: pointer;
            text-decoration: underline;
        }

        .model-selector {
            margin-bottom: 20px;
        }

        .zhipu-login {
            border-top: 1px solid var(--light-gray);
            padding-top: 20px;
            margin-top: 20px;
        }

        .zhipu-link {
            color: var(--primary-red);
            text-decoration: none;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .logout-button {
            background-color: var(--primary-red);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
        }

        .chat-container {
            background-color: white;
            border-radius: 12px;
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 15px;
            max-width: 80%;
        }

        .user-message {
            margin-left: auto;
        }

        .user-message .message-content {
            background-color: var(--primary-red);
            color: white;
            padding: 12px 16px;
            border-radius: 18px 18px 4px 18px;
        }

        .ai-message .message-content {
            background-color: var(--light-gray);
            color: var(--dark-gray);
            padding: 12px 16px;
            border-radius: 18px 18px 18px 4px;
            white-space: pre-wrap;
        }

        .message-time {
            font-size: 12px;
            color: var(--medium-gray);
            margin-top: 5px;
            text-align: right;
        }

        .ai-message .message-time {
            text-align: left;
        }

        .chat-input {
            padding: 20px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            gap: 10px;
        }

        .chat-input textarea {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--light-gray);
            border-radius: 8px;
            resize: none;
        }

        .send-button {
            background-color: var(--primary-red);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--medium-gray);
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 10px;
            }
            
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // ä¸»åº”ç”¨ç»„ä»¶
        function App() {
            const [activeTab, setActiveTab] = React.useState('guide');
            
            return (
                <div className="app-container">
                    <div className="header">
                        <h1>å°çº¢å¡</h1>
                        <p>å¹¶å‘ç—‡ç®¡ç†æŒ‡å¼•ç”Ÿæˆå™¨</p>
                    </div>
                    
                    <div className="tabs">
                        <div 
                            className={`tab ${activeTab === 'guide' ? 'active' : ''}`}
                            onClick={() => setActiveTab('guide')}
                        >
                            æŒ‡å¼•ç”Ÿæˆ
                        </div>
                        <div 
                            className={`tab ${activeTab === 'ai' ? 'active' : ''}`}
                            onClick={() => setActiveTab('ai')}
                        >
                            AIåŠ©æ‰‹
                        </div>
                    </div>
                    
                    <div className="tab-content">
                        {activeTab === 'guide' ? <GuideGenerator /> : <AIAssistant />}
                    </div>
                </div>
            );
        }

        // æŒ‡å¼•ç”Ÿæˆå™¨ç»„ä»¶
        function GuideGenerator() {
            const [currentStep, setCurrentStep] = React.useState(0);
            const [selectedComplications, setSelectedComplications] = React.useState([]);
            const [medicalInfo, setMedicalInfo] = React.useState({
                name: '',
                age: '',
                bloodType: '',
                mainDiagnosis: '',
                surgeryHistory: '',
                allergies: '',
                otherDiseases: '',
                isOnAnticoagulation: false,
                medicationType: '',
                lastTaken: '',
                stopReason: ''
            });
            const [emergencyContacts, setEmergencyContacts] = React.useState([]);
            const [hospitals, setHospitals] = React.useState([]);
            
            // ä»localStorageåŠ è½½æ•°æ®
            React.useEffect(() => {
                const savedComplications = JSON.parse(localStorage.getItem('selectedComplications') || '[]');
                const savedMedicalInfo = JSON.parse(localStorage.getItem('medicalInfo') || '{}');
                const savedContacts = JSON.parse(localStorage.getItem('emergencyContacts') || '[]');
                const savedHospitals = JSON.parse(localStorage.getItem('hospitals') || '[]');
                
                if (savedComplications.length > 0) {
                    setSelectedComplications(savedComplications);
                }
                
                if (Object.keys(savedMedicalInfo).length > 0) {
                    setMedicalInfo(savedMedicalInfo);
                }
                
                if (savedContacts.length > 0) {
                    setEmergencyContacts(savedContacts);
                }
                
                if (savedHospitals.length > 0) {
                    setHospitals(savedHospitals);
                }
            }, []);
            
            // ä¿å­˜æ•°æ®åˆ°localStorage
            React.useEffect(() => {
                localStorage.setItem('selectedComplications', JSON.stringify(selectedComplications));
            }, [selectedComplications]);
            
            React.useEffect(() => {
                localStorage.setItem('medicalInfo', JSON.stringify(medicalInfo));
            }, [medicalInfo]);
            
            React.useEffect(() => {
                localStorage.setItem('emergencyContacts', JSON.stringify(emergencyContacts));
            }, [emergencyContacts]);
            
            React.useEffect(() => {
                localStorage.setItem('hospitals', JSON.stringify(hospitals));
            }, [hospitals]);
            
            const complications = [
                { id: 'bleeding', name: 'æ¶ˆåŒ–é“å‡ºè¡€', description: 'å‘•è¡€ã€é»‘ä¾¿ç­‰ç—‡çŠ¶çš„ç´§æ€¥å¤„ç†' },
                { id: 'obstruction', name: 'è‚ æ¢—é˜»', description: 'è…¹ç—›ã€å‘•åã€è…¹èƒ€ç­‰ç—‡çŠ¶çš„ç´§æ€¥å¤„ç†' },
                { id: 'biliary', name: 'èƒ†é“æ¢—é˜»', description: 'é»„ç–¸ã€å‘çƒ­ç­‰ç—‡çŠ¶ç®¡ç†' },
                { id: 'infection', name: 'æ„ŸæŸ“', description: 'å‘çƒ­ã€æ„ŸæŸ“å¾è±¡ç›‘æµ‹' },
                { id: 'ascites', name: 'è…¹æ°´', description: 'è…¹èƒ€ã€è…¹æ°´ç—‡çŠ¶ç®¡ç†' },
                { id: 'thrombosis', name: 'è¡€æ “', description: 'è¡€æ “å½¢æˆé¢„é˜²å’Œå¤„ç†' }
            ];
            
            const handleComplicationChange = (id) => {
                if (selectedComplications.includes(id)) {
                    setSelectedComplications(selectedComplications.filter(c => c !== id));
                } else {
                    setSelectedComplications([...selectedComplications, id]);
                }
            };
            
            const handleMedicalInfoChange = (field, value) => {
                setMedicalInfo({
                    ...medicalInfo,
                    [field]: value
                });
            };
            
            const nextStep = () => {
                if (currentStep < 3) {
                    setCurrentStep(currentStep + 1);
                }
            };
            
            const prevStep = () => {
                if (currentStep > 0) {
                    setCurrentStep(currentStep - 1);
                }
            };
            
            const canProceed = () => {
                switch (currentStep) {
                    case 0: return selectedComplications.length > 0;
                    case 1: return medicalInfo.name && medicalInfo.bloodType;
                    case 2: return emergencyContacts.length > 0 || hospitals.length > 0;
                    default: return true;
                }
            };
            
            const renderStep = () => {
                switch (currentStep) {
                    case 0:
                        return (
                            <div>
                                <h2>é€‰æ‹©å¹¶å‘ç—‡ç±»å‹</h2>
                                <div className="checkbox-group">
                                    {complications.map(comp => (
                                        <div 
                                            key={comp.id}
                                            className={`checkbox-item ${selectedComplications.includes(comp.id) ? 'selected' : ''}`}
                                            onClick={() => handleComplicationChange(comp.id)}
                                        >
                                            <input 
                                                type="checkbox" 
                                                checked={selectedComplications.includes(comp.id)}
                                                onChange={() => {}}
                                            />
                                            <div className="checkbox-item-content">
                                                <h4>{comp.name}</h4>
                                                <p>{comp.description}</p>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    case 1:
                        return (
                            <div>
                                <h2>å¡«å†™ä¸ªäººåŒ»ç–—ä¿¡æ¯</h2>
                                <div className="form-group">
                                    <label>å§“å</label>
                                    <input 
                                        type="text" 
                                        value={medicalInfo.name}
                                        onChange={(e) => handleMedicalInfoChange('name', e.target.value)}
                                        placeholder="è¯·è¾“å…¥å§“å"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>å¹´é¾„</label>
                                    <input 
                                        type="number" 
                                        value={medicalInfo.age}
                                        onChange={(e) => handleMedicalInfoChange('age', e.target.value)}
                                        placeholder="è¯·è¾“å…¥å¹´é¾„"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>è¡€å‹</label>
                                    <select 
                                        value={medicalInfo.bloodType}
                                        onChange={(e) => handleMedicalInfoChange('bloodType', e.target.value)}
                                    >
                                        <option value="">è¯·é€‰æ‹©è¡€å‹</option>
                                        <option value="Aå‹">Aå‹</option>
                                        <option value="Bå‹">Bå‹</option>
                                        <option value="ABå‹">ABå‹</option>
                                        <option value="Oå‹">Oå‹</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label>ä¸»è¦è¯Šæ–­</label>
                                    <input 
                                        type="text" 
                                        value={medicalInfo.mainDiagnosis}
                                        onChange={(e) => handleMedicalInfoChange('mainDiagnosis', e.target.value)}
                                        placeholder="è¯·è¾“å…¥ä¸»è¦è¯Šæ–­"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>æ‰‹æœ¯å²</label>
                                    <textarea 
                                        value={medicalInfo.surgeryHistory}
                                        onChange={(e) => handleMedicalInfoChange('surgeryHistory', e.target.value)}
                                        placeholder="è¯·è¾“å…¥æ‰‹æœ¯å²"
                                    />
                                </div>
                                <div className="form-group">
                                    <label>è¿‡æ•å²</label>
                                    <textarea 
                                        value={medicalInfo.allergies}
                                        onChange={(e) => handleMedicalInfoChange('allergies', e.target.value)}
                                        placeholder="è¯·è¾“å…¥è¿‡æ•å²"
                                    />
                                </div>
                            </div>
                        );
                    case 2:
                        return (
                            <div>
                                <h2>ç´§æ€¥è”ç³»äººå’ŒåŒ»é™¢ä¿¡æ¯</h2>
                                <p>è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªç´§æ€¥è”ç³»äººæˆ–åŒ»é™¢ä¿¡æ¯</p>
                                
                                <div className="form-group">
                                    <label>ç´§æ€¥è”ç³»äºº</label>
                                    <div className="contact-list">
                                        {emergencyContacts.map((contact, index) => (
                                            <div key={index} className="contact-item">
                                                <span>{contact.name} ({contact.relationship}) - {contact.phone}</span>
                                                <button 
                                                    className="remove-btn"
                                                    onClick={() => {
                                                        const newContacts = [...emergencyContacts];
                                                        newContacts.splice(index, 1);
                                                        setEmergencyContacts(newContacts);
                                                    }}
                                                >
                                                    åˆ é™¤
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={() => {
                                            const name = prompt('è¯·è¾“å…¥è”ç³»äººå§“å:');
                                            const phone = prompt('è¯·è¾“å…¥è”ç³»ç”µè¯:');
                                            const relationship = prompt('è¯·è¾“å…¥å…³ç³»:');
                                            if (name && phone && relationship) {
                                                setEmergencyContacts([...emergencyContacts, { name, phone, relationship }]);
                                            }
                                        }}
                                    >
                                        æ·»åŠ è”ç³»äºº
                                    </button>
                                </div>
                                
                                <div className="form-group">
                                    <label>åŒ»é™¢ä¿¡æ¯</label>
                                    <div className="hospital-list">
                                        {hospitals.map((hospital, index) => (
                                            <div key={index} className="hospital-item">
                                                <span>{hospital.name} - {hospital.emergency}</span>
                                                <button 
                                                    className="remove-btn"
                                                    onClick={() => {
                                                        const newHospitals = [...hospitals];
                                                        newHospitals.splice(index, 1);
                                                        setHospitals(newHospitals);
                                                    }}
                                                >
                                                    åˆ é™¤
                                                </button>
                                            </div>
                                        ))}
                                    </div>
                                    <button 
                                        className="btn btn-secondary"
                                        onClick={() => {
                                            const name = prompt('è¯·è¾“å…¥åŒ»é™¢åç§°:');
                                            const emergency = prompt('è¯·è¾“å…¥æ€¥è¯Šç”µè¯:');
                                            const address = prompt('è¯·è¾“å…¥åŒ»é™¢åœ°å€:');
                                            if (name && emergency && address) {
                                                setHospitals([...hospitals, { name, emergency, address }]);
                                            }
                                        }}
                                    >
                                        æ·»åŠ åŒ»é™¢
                                    </button>
                                </div>
                            </div>
                        );
                    case 3:
                        return <CardPreview 
                            selectedComplications={selectedComplications}
                            medicalInfo={medicalInfo}
                            emergencyContacts={emergencyContacts}
                            hospitals={hospitals}
                        />;
                    default:
                        return null;
                }
            };
            
            return (
                <div>
                    <div className="steps">
                        {['é€‰æ‹©å¹¶å‘ç—‡', 'åŒ»ç–—ä¿¡æ¯', 'è”ç³»ä¿¡æ¯', 'ç”Ÿæˆå¡ç‰‡'].map((title, index) => (
                            <div key={index} className={`step ${currentStep === index ? 'active' : ''}`}>
                                <div className="step-number">{index + 1}</div>
                                <div className="step-title">{title}</div>
                            </div>
                        ))}
                    </div>
                    
                    {renderStep()}
                    
                    <div className="button-group">
                        <button 
                            className="btn btn-secondary"
                            onClick={prevStep}
                            disabled={currentStep === 0}
                        >
                            ä¸Šä¸€æ­¥
                        </button>
                        <button 
                            className="btn btn-primary"
                            onClick={nextStep}
                            disabled={currentStep === 3 || !canProceed()}
                        >
                            {currentStep === 3 ? 'å®Œæˆ' : 'ä¸‹ä¸€æ­¥'}
                        </button>
                    </div>
                </div>
            );
        }

        // å¡ç‰‡é¢„è§ˆç»„ä»¶
        function CardPreview({ selectedComplications, medicalInfo, emergencyContacts, hospitals }) {
            const cardRef = React.useRef(null);
            
            const complications = [
                { id: 'bleeding', name: 'æ¶ˆåŒ–é“å‡ºè¡€', description: 'å‘•è¡€ã€é»‘ä¾¿ç­‰ç—‡çŠ¶çš„ç´§æ€¥å¤„ç†' },
                { id: 'obstruction', name: 'è‚ æ¢—é˜»', description: 'è…¹ç—›ã€å‘•åã€è…¹èƒ€ç­‰ç—‡çŠ¶çš„ç´§æ€¥å¤„ç†' },
                { id: 'biliary', name: 'èƒ†é“æ¢—é˜»', description: 'é»„ç–¸ã€å‘çƒ­ç­‰ç—‡çŠ¶ç®¡ç†' },
                { id: 'infection', name: 'æ„ŸæŸ“', description: 'å‘çƒ­ã€æ„ŸæŸ“å¾è±¡ç›‘æµ‹' },
                { id: 'ascites', name: 'è…¹æ°´', description: 'è…¹èƒ€ã€è…¹æ°´ç—‡çŠ¶ç®¡ç†' },
                { id: 'thrombosis', name: 'è¡€æ “', description: 'è¡€æ “å½¢æˆé¢„é˜²å’Œå¤„ç†' }
            ];
            
            const getSelectedComplicationNames = () => {
                return selectedComplications.map(id => 
                    complications.find(comp => comp.id === id)?.name
                ).filter(Boolean).join('ã€');
            };
            
            const handleDownloadImage = async () => {
                if (cardRef.current) {
                    try {
                        const canvas = await html2canvas(cardRef.current, {
                            backgroundColor: '#ffffff',
                            scale: 2
                        });
                        const image = canvas.toDataURL('image/png');
                        const link = document.createElement('a');
                        link.download = `å°çº¢å¡_${medicalInfo.name || 'æ‚£è€…'}_${new Date().toISOString().split('T')[0]}.png`;
                        link.href = image;
                        link.click();
                    } catch (error) {
                        alert('ä¸‹è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                        console.error('ä¸‹è½½é”™è¯¯:', error);
                    }
                }
            };
            
            return (
                <div>
                    <h2>å°çº¢å¡é¢„è§ˆ</h2>
                    
                    <div ref={cardRef} className="card-preview">
                        <div className="card-header">
                            <div className="card-title">å°çº¢å¡</div>
                            <div className="card-subtitle">{getSelectedComplicationNames()}ç®¡ç†æŒ‡å¼•</div>
                        </div>
                        
                        <div className="emergency-section">
                            <div className="emergency-title">ğŸš¨ ç´§æ€¥æƒ…å†µå¤„ç†</div>
                            <p>â€¢ ç«‹å³æ‹¨æ‰“120æ€¥æ•‘ç”µè¯</p>
                            <p>â€¢ ä¿æŒå†·é™ï¼ŒæŒ‰ç…§åŒ»ç”ŸæŒ‡å¯¼æ“ä½œ</p>
                            <p>â€¢ è®°å½•ç—‡çŠ¶å‘ç”Ÿæ—¶é—´å’Œä¸¥é‡ç¨‹åº¦</p>
                        </div>
                        
                        <div className="info-grid">
                            <div className="info-item">
                                <div className="info-label">æ‚£è€…å§“å</div>
                                <div className="info-value">{medicalInfo.name || 'æœªå¡«å†™'}</div>
                            </div>
                            <div className="info-item">
                                <div className="info-label">å¹´é¾„</div>
                                <div className="info-value">{medicalInfo.age || 'æœªå¡«å†™'}</div>
                            </div>
                            <div className="info-item">
                                <div className="info-label">è¡€å‹</div>
                                <div className="info-value">{medicalInfo.bloodType || 'æœªå¡«å†™'}</div>
                            </div>
                            <div className="info-item">
                                <div className="info-label">ä¸»è¦è¯Šæ–­</div>
                                <div className="info-value">{medicalInfo.mainDiagnosis || 'æœªå¡«å†™'}</div>
                            </div>
                        </div>
                        
                        {emergencyContacts.length > 0 && (
                            <div className="diagnosis-section">
                                <div className="emergency-title">ğŸ“ ç´§æ€¥è”ç³»äºº</div>
                                {emergencyContacts.map((contact, index) => (
                                    <p key={index}>â€¢ {contact.name} ({contact.relationship}): {contact.phone}</p>
                                ))}
                            </div>
                        )}
                        
                        {hospitals.length > 0 && (
                            <div className="prevention-section">
                                <div className="emergency-title">ğŸ¥ åŒ»é™¢ä¿¡æ¯</div>
                                {hospitals.map((hospital, index) => (
                                    <p key={index}>â€¢ {hospital.name}: {hospital.emergency}</p>
                                ))}
                            </div>
                        )}
                        
                        <div style={{ textAlign: 'center', marginTop: '20px', fontSize: '12px', color: '#666' }}>
                            ç”Ÿæˆæ—¶é—´: {new Date().toLocaleString()}
                        </div>
                    </div>
                    
                    <div className="button-group" style={{ marginTop: '20px' }}>
                        <button className="btn btn-primary" onClick={handleDownloadImage}>
                            ä¸‹è½½ä¸ºå›¾ç‰‡
                        </button>
                        <button 
                            className="btn btn-secondary"
                            onClick={() => {
                                localStorage.clear();
                                window.location.reload();
                            }}
                        >
                            æ¸…ç©ºé‡æ–°å¼€å§‹
                        </button>
                    </div>
                </div>
            );
        }

        // AIåŠ©æ‰‹ç»„ä»¶
        function AIAssistant() {
            const [isLoggedIn, setIsLoggedIn] = React.useState(false);
            const [isLogin, setIsLogin] = React.useState(true);
            const [username, setUsername] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [confirmPassword, setConfirmPassword] = React.useState('');
            const [email, setEmail] = React.useState('');
            const [zhipuApiKey, setZhipuApiKey] = React.useState('');
            const [selectedModel, setSelectedModel] = React.useState('glm-4.5-air');
            const [messages, setMessages] = React.useState([]);
            const [inputText, setInputText] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const messagesEndRef = React.useRef(null);
            
            React.useEffect(() => {
                const loggedIn = localStorage.getItem('isLoggedIn') === 'true';
                setIsLoggedIn(loggedIn);
                
                if (loggedIn) {
                    const savedApiKey = localStorage.getItem('zhipuApiKey');
                    if (savedApiKey) {
                        setZhipuApiKey(savedApiKey);
                    }
                    
                    const savedModel = localStorage.getItem('selectedModel');
                    if (savedModel) {
                        setSelectedModel(savedModel);
                    }
                    
                    setMessages([{
                        id: Date.now(),
                        text: 'æ‚¨å¥½ï¼æˆ‘æ˜¯å¹¶å‘ç—‡ç®¡ç†AIåŠ©æ‰‹ï¼Œå¯ä»¥ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„åŒ»ç–—å»ºè®®å’ŒæŒ‡å¯¼ã€‚è¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ',
                        sender: 'ai',
                        timestamp: new Date()
                    }]);
                }
            }, []);
            
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
            };
            
            React.useEffect(scrollToBottom, [messages]);
            
            const handleRegister = () => {
                if (password !== confirmPassword) {
                    alert('å¯†ç ä¸ä¸€è‡´');
                    return;
                }
                
                if (!username || !password) {
                    alert('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ');
                    return;
                }
                
                localStorage.setItem('username', username);
                localStorage.setItem('password', password);
                alert('æ³¨å†ŒæˆåŠŸï¼è¯·ç™»å½•');
                setIsLogin(true);
            };
            
            const handleLogin = () => {
                if (!zhipuApiKey) {
                    alert('è¯·è¾“å…¥æ™ºè°±AI APIå¯†é’¥');
                    return;
                }
                
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('zhipuApiKey', zhipuApiKey);
                localStorage.setItem('selectedModel', selectedModel);
                setIsLoggedIn(true);
            };
            
            const handleLogout = () => {
                localStorage.removeItem('isLoggedIn');
                setIsLoggedIn(false);
                setMessages([]);
            };
            
            const getModelName = (model) => {
                const modelNames = {
                    'glm-4.5': 'GLM-4.5',
                    'glm-4.5-air': 'GLM-4.5-Air',
                    'glm-4.5-airx': 'GLM-4.5-AirX',
                    'glm-4.5-flash': 'GLM-4.5-Flash',
                    'glm-4.1v-thinking-flashx': 'GLM-4.1V-Thinking'
                };
                return modelNames[model] || model;
            };
            
            const handleSendMessage = async () => {
                if (!inputText.trim()) return;
                
                const userMessage = {
                    id: Date.now(),
                    text: inputText,
                    sender: 'user',
                    timestamp: new Date()
                };
                
                setMessages(prev => [...prev, userMessage]);
                setInputText('');
                setIsLoading(true);
                
                try {
                    // è¿™é‡Œå¯ä»¥é›†æˆçœŸå®çš„AI API
                    const aiResponse = getAIResponse(inputText);
                    
                    const aiMessage = {
                        id: Date.now() + 1,
                        text: aiResponse,
                        sender: 'ai',
                        timestamp: new Date()
                    };
                    
                    setMessages(prev => [...prev, aiMessage]);
                } catch (error) {
                    console.error('AIå“åº”é”™è¯¯:', error);
                    const errorMessage = {
                        id: Date.now() + 1,
                        text: 'æŠ±æ­‰ï¼ŒAIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•ã€‚',
                        sender: 'ai',
                        timestamp: new Date()
                    };
                    setMessages(prev => [...prev, errorMessage]);
                } finally {
                    setIsLoading(false);
                }
            };
            
            const getAIResponse = (question) => {
                const lowerQuestion = question.toLowerCase();
                
                if (lowerQuestion.includes('è‚ æ¢—é˜»')) {
                    return `ğŸŸ¡ **æ³¨æ„è­¦ç¤º**ï¼šè‚ æ¢—é˜»éœ€è¦åŒ»ç–—ä¸“ä¸šè¯„ä¼°

ğŸ¥ **å»ºè®®æ—¶é—´**ï¼šå»ºè®®24-48å°æ—¶å†…å°±åŒ»

ğŸ” **ç—…æƒ…è¯Šæ–­å…³é”®æŒ‡å¼•**ï¼š
- å¯†åˆ‡è§‚å¯Ÿè…¹ç—›æ€§è´¨ã€é¢‘ç‡å’Œéƒ¨ä½
- è®°å½•å‘•åç‰©çš„é¢œè‰²ã€é‡å’Œæ¬¡æ•°
- æ³¨æ„è…¹èƒ€ç¨‹åº¦å’Œæ’æ°”æ’ä¾¿æƒ…å†µ
- ç›‘æµ‹ä½“æ¸©å˜åŒ–

ğŸ  **æ—¥å¸¸æ³¨æ„å’Œé¢„é˜²**ï¼š
- é¥®é£Ÿï¼šé¿å…éš¾æ¶ˆåŒ–é£Ÿç‰©å¦‚ç³¯ç±³ã€åšæœ
- æ´»åŠ¨ï¼šé€‚å½“æ´»åŠ¨ä¿ƒè¿›è‚ è •åŠ¨ï¼Œé¿å…å‰§çƒˆè¿åŠ¨
- ç”¨è¯ï¼šéµåŒ»å˜±ä½¿ç”¨è¯ç‰©ï¼Œä¸è‡ªè¡Œç”¨è¯`;
                } else if (lowerQuestion.includes('å‡ºè¡€')) {
                    return `ğŸ”´ **ç´§æ€¥è­¦ç¤º**ï¼šæ¶ˆåŒ–é“å‡ºè¡€å¯èƒ½å±åŠç”Ÿå‘½

âš ï¸ **ç«‹å³è¡ŒåŠ¨**ï¼šè¯·ç«‹å³æ‹¨æ‰“120æˆ–å‰å¾€æœ€è¿‘åŒ»é™¢æ€¥è¯Šç§‘

ğŸ†˜ **æ€¥æ•‘æŒ‡å¯¼æ­¥éª¤**ï¼š
1. ç»å¯¹ç¦é£Ÿç¦æ°´
2. ä¿æŒå‘¼å¸é“é€šç•…ï¼Œä¾§å§ä½
3. è®°å½•å‘•è¡€å’Œé»‘ä¾¿çš„é‡ã€é¢œè‰²å’Œæ—¶é—´
4. ä¿æŒé•‡é™ï¼Œé¿å…ç´§å¼ åŠ é‡å‡ºè¡€

ğŸ” **ç—…æƒ…è¯Šæ–­å…³é”®æŒ‡å¼•**ï¼š
- å‘•è¡€é²œçº¢è‰²æç¤ºæ´»åŠ¨æ€§å‡ºè¡€
- é»‘ä¾¿å‘ˆæŸæ²¹æ ·æç¤ºä¸Šæ¶ˆåŒ–é“å‡ºè¡€
- å¤´æ™•ã€å¿ƒæ…Œã€å‡ºå†·æ±—æç¤ºå¤±è¡€è¾ƒå¤š`;
                } else {
                    return `æ„Ÿè°¢æ‚¨çš„æé—®ã€‚ä½œä¸ºå¹¶å‘ç—‡ç®¡ç†AIåŠ©æ‰‹ï¼Œæˆ‘å¯ä»¥ä¸ºæ‚¨æä¾›å…³äºå¹¶å‘ç—‡é¢„é˜²ã€è¯†åˆ«å’Œå¤„ç†çš„ä¸“ä¸šå»ºè®®ã€‚

ğŸ” **ç—…æƒ…è¯Šæ–­å…³é”®æŒ‡å¼•**ï¼š
- å¯†åˆ‡è§‚å¯Ÿèº«ä½“å˜åŒ–ï¼Œè®°å½•ç—‡çŠ¶
- æ³¨æ„ç”Ÿå‘½ä½“å¾ï¼šä½“æ¸©ã€è¡€å‹ã€å¿ƒç‡ç­‰
- è¯†åˆ«å¹¶å‘ç—‡çš„æ—©æœŸä¿¡å·

ğŸ  **æ—¥å¸¸æ³¨æ„å’Œé¢„é˜²**ï¼š
- ä¿æŒè§„å¾‹ä½œæ¯ï¼Œå……è¶³ç¡çœ 
- å‡è¡¡é¥®é£Ÿï¼Œé€‚é‡è¿åŠ¨
- éµåŒ»å˜±ç”¨è¯ï¼Œå®šæœŸå¤æŸ¥

æ‚¨æœ‰å…·ä½“çš„å¹¶å‘ç—‡é—®é¢˜éœ€è¦å’¨è¯¢å—ï¼Ÿ`;
                }
            };
            
            const handleKeyPress = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleSendMessage();
                }
            };
            
            if (!isLoggedIn) {
                return (
                    <div className="auth-container">
                        {!isLogin ? (
                            <div className="auth-form">
                                <h2>æ³¨å†Œè´¦å·</h2>
                                <div className="form-group">
                                    <label>ç”¨æˆ·å</label>
                                    <input 
                                        type="text" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)} 
                                        placeholder="è¯·è¾“å…¥ç”¨æˆ·å" 
                                    />
                                </div>
                                <div className="form-group">
                                    <label>å¯†ç </label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                        placeholder="è¯·è¾“å…¥å¯†ç " 
                                    />
                                </div>
                                <div className="form-group">
                                    <label>ç¡®è®¤å¯†ç </label>
                                    <input 
                                        type="password" 
                                        value={confirmPassword} 
                                        onChange={(e) => setConfirmPassword(e.target.value)} 
                                        placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " 
                                    />
                                </div>
                                <div className="form-group">
                                    <label>é‚®ç®±(é€‰å¡«)</label>
                                    <input 
                                        type="email" 
                                        value={email} 
                                        onChange={(e) => setEmail(e.target.value)} 
                                        placeholder="è¯·è¾“å…¥é‚®ç®±" 
                                    />
                                </div>
                                <button className="auth-button" onClick={handleRegister}>æ³¨å†Œ</button>
                                <div className="auth-toggle">
                                    å·²æœ‰è´¦å·ï¼Ÿ<span onClick={() => setIsLogin(true)}>ç™»å½•</span>
                                </div>
                            </div>
                        ) : (
                            <div className="auth-form">
                                <h2>ç™»å½•</h2>
                                <div className="form-group">
                                    <label>ç”¨æˆ·å</label>
                                    <input 
                                        type="text" 
                                        value={username} 
                                        onChange={(e) => setUsername(e.target.value)} 
                                        placeholder="è¯·è¾“å…¥ç”¨æˆ·å" 
                                    />
                                </div>
                                <div className="form-group">
                                    <label>å¯†ç </label>
                                    <input 
                                        type="password" 
                                        value={password} 
                                        onChange={(e) => setPassword(e.target.value)} 
                                        placeholder="è¯·è¾“å…¥å¯†ç " 
                                    />
                                </div>
                                
                                <div className="model-selector">
                                    <label>é€‰æ‹©æ¨¡å‹</label>
                                    <select 
                                        value={selectedModel}
                                        onChange={(e) => setSelectedModel(e.target.value)}
                                    >
                                        <option value="glm-4.5">GLM-4.5</option>
                                        <option value="glm-4.5-air">GLM-4.5-Air (æ¨è)</option>
                                        <option value="glm-4.5-airx">GLM-4.5-AirX</option>
                                        <option value="glm-4.5-flash">GLM-4.5-Flash (å…è´¹)</option>
                                        <option value="glm-4.1v-thinking-flashx">GLM-4.1V-Thinking (å…è´¹)</option>
                                    </select>
                                </div>
                                
                                <div className="zhipu-login">
                                    <h3>æ™ºè°±AI APIå¯†é’¥</h3>
                                    <div className="form-group">
                                        <label>APIå¯†é’¥</label>
                                        <input 
                                            type="password" 
                                            value={zhipuApiKey} 
                                            onChange={(e) => setZhipuApiKey(e.target.value)} 
                                            placeholder="è¯·è¾“å…¥æ™ºè°±AI APIå¯†é’¥" 
                                        />
                                    </div>
                                    <p>
                                        æ²¡æœ‰APIå¯†é’¥ï¼Ÿ
                                        <a href="https://open.bigmodel.cn/" target="_blank" className="zhipu-link">ç‚¹å‡»æ³¨å†Œæ™ºè°±AI</a>
                                    </p>
                                </div>
                                
                                <button className="auth-button" onClick={handleLogin}>ç™»å½•</button>
                                <div className="auth-toggle">
                                    æ²¡æœ‰è´¦å·ï¼Ÿ<span onClick={() => setIsLogin(false)}>æ³¨å†Œ</span>
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            
            return (
                <div>
                    <div className="user-info">
                        <span>æ¬¢è¿ï¼Œ{username} (å½“å‰æ¨¡å‹: {getModelName(selectedModel)})</span>
                        <button className="logout-button" onClick={handleLogout}>é€€å‡º</button>
                    </div>
                    
                    <div className="chat-container">
                        <div className="chat-messages">
                            {messages.map((message) => (
                                <div 
                                    key={message.id} 
                                    className={`message ${message.sender === 'user' ? 'user-message' : 'ai-message'}`}
                                >
                                    <div className="message-content">{message.text}</div>
                                    <div className="message-time">
                                        {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                </div>
                            ))}
                            {isLoading && (
                                <div className="message ai-message">
                                    <div className="message-content typing-indicator">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>
                        
                        <div className="chat-input">
                            <textarea
                                value={inputText}
                                onChange={(e) => setInputText(e.target.value)}
                                onKeyPress={handleKeyPress}
                                placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."
                                rows={2}
                            />
                            <button 
                                className="send-button" 
                                onClick={handleSendMessage}
                                disabled={!inputText.trim() || isLoading}
                            >
                                å‘é€
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // æ¸²æŸ“åº”ç”¨ - ä½¿ç”¨React 18çš„æ–°API
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>